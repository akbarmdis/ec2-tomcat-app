# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

This is a complete Apache Tomcat web application deployment solution for AWS EC2, featuring Infrastructure as Code with Terraform, automated deployment scripts, and a sample Java servlet-based web application. The project demonstrates a full production-ready deployment pipeline from source code to AWS infrastructure.

## Common Development Commands

### Prerequisites Check
```bash
# Verify all required tools are installed
terraform --version
aws --version
java -version
mvn --version

# Check AWS credentials
aws sts get-caller-identity
```

### Infrastructure Management
```bash
# Provision AWS infrastructure (creates EC2, VPC, security groups, etc.)
./scripts/setup-infrastructure.sh

# Deploy application to EC2
./scripts/deploy.sh

# Destroy all AWS resources (important for cost management)
./scripts/cleanup.sh
```

### Application Development
```bash
# Build the Java web application
cd app
mvn clean package

# Run tests (if any exist)
mvn test

# Local development with Tomcat plugin
mvn tomcat7:run

# Clean build artifacts
mvn clean
```

### Infrastructure Inspection
```bash
# View Terraform outputs (after infrastructure is created)
cd terraform
terraform output

# Show current infrastructure state
terraform show

# Plan infrastructure changes
terraform plan

# Apply specific infrastructure changes
terraform apply
```

### Debugging and Monitoring
```bash
# SSH into EC2 instance (after setup-infrastructure.sh)
ssh -i ~/.ssh/tomcat-app-key ec2-user@<INSTANCE_IP>

# View Tomcat logs on EC2
ssh -i ~/.ssh/tomcat-app-key ec2-user@<INSTANCE_IP> 'sudo tail -f /opt/tomcat/logs/catalina.out'

# Check Tomcat service status
ssh -i ~/.ssh/tomcat-app-key ec2-user@<INSTANCE_IP> 'sudo systemctl status tomcat'
```

## Architecture Overview

### Three-Layer Architecture
1. **Infrastructure Layer**: Terraform manages AWS resources (VPC, EC2, security groups, Elastic IP)
2. **Application Layer**: Java servlet application built with Maven, deployed as WAR file
3. **Automation Layer**: Shell scripts orchestrate the build and deployment pipeline

### Key Components

#### Terraform Infrastructure (`terraform/`)
- **main.tf**: Defines complete AWS infrastructure including VPC, subnets, security groups, EC2 instance, and Elastic IP
- **user_data.sh**: EC2 initialization script that installs Java 8, Tomcat 9, and configures nginx as reverse proxy
- **variables.tf**: Configurable parameters (AWS region, instance type, Tomcat version, SSH key)
- **outputs.tf**: Exposes instance IP, DNS, and connection information

#### Java Web Application (`app/`)
- **Maven project** with standard directory structure
- **HelloServlet.java**: Sample servlet demonstrating HTTP request handling, server info display, and parameterized responses
- **JSP pages**: index.jsp (main UI) and error.jsp (error handling)
- **web.xml**: Servlet configuration and error page mapping
- Built as WAR file for Tomcat deployment

#### Deployment Pipeline (`scripts/`)
- **setup-infrastructure.sh**: End-to-end infrastructure provisioning with SSH key generation, Terraform variable setup, and connectivity testing
- **deploy.sh**: Application build and deployment with Maven packaging, SCP transfer to EC2, and Tomcat service management
- **cleanup.sh**: Complete teardown including AWS resource destruction and local file cleanup

### Data Flow
1. Developer runs `setup-infrastructure.sh` → Terraform provisions AWS infrastructure → EC2 instance auto-configures with Java/Tomcat
2. Developer runs `deploy.sh` → Maven builds WAR file → SCP transfers to EC2 → Tomcat deploys application
3. User accesses application via Elastic IP → Nginx reverse proxy → Tomcat serves application

### Critical Dependencies
- **SSH Key Management**: Scripts generate and manage `~/.ssh/tomcat-app-key` for EC2 access
- **Terraform State**: Infrastructure state stored in `terraform/terraform.tfstate` - essential for updates/destruction
- **Maven Target Directory**: WAR file built to `app/target/tomcat-webapp.war`
- **AWS Credentials**: Must be configured via `aws configure` or environment variables

## Configuration Files

### Terraform Variables (`terraform/terraform.tfvars`)
Generated by setup script with:
- AWS region (defaults to us-west-2)
- Instance type (defaults to t3.micro)
- Tomcat version (defaults to 9.0.82)
- SSH public key content

### Application Endpoints
- `/` - Main application homepage (index.jsp)
- `/hello` - HelloServlet with server information
- `/hello?name=<name>` - Personalized greeting
- `:8080/manager` - Tomcat manager (requires authentication)

### Security Configuration
- Security group allows ports 22 (SSH), 80 (HTTP), 443 (HTTPS), 8080 (Tomcat)
- Default manager credentials: admin/admin123! (should be changed in production)
- SSH access via generated key pair

## Development Workflow

### Making Application Changes
1. Modify Java/JSP files in `app/src/`
2. Test locally if needed: `cd app && mvn tomcat7:run`
3. Deploy to EC2: `./scripts/deploy.sh` (automatically rebuilds and redeploys)

### Infrastructure Changes
1. Modify Terraform files in `terraform/`
2. Plan changes: `cd terraform && terraform plan`
3. Apply changes: `terraform apply`

### Adding New Servlets
1. Create servlet class in `app/src/main/java/com/example/webapp/`
2. Configure servlet mapping in `app/src/main/webapp/WEB-INF/web.xml`
3. Redeploy with `./scripts/deploy.sh`

## Cost Management

**Important**: This project creates AWS resources that incur costs. Always run `./scripts/cleanup.sh` when finished to destroy all resources and avoid charges.

### Resource Costs (approximate)
- t3.micro EC2 instance: ~$8.50/month
- Elastic IP: $3.65/month (when not attached)
- EBS storage: ~$0.80/month for 8GB

### Cleanup Process
The cleanup script will:
1. Show current resources
2. Require explicit confirmation
3. Run `terraform destroy`
4. Remove local state files
5. Optionally remove SSH keys

## Troubleshooting

### Common Issues
- **SSH connection fails**: Check key permissions (`chmod 600 ~/.ssh/tomcat-app-key`)
- **Tomcat won't start**: Check logs via SSH and examine Java version compatibility
- **Application not accessible**: Verify security group rules and instance public IP
- **Build fails**: Ensure Java 8+ and Maven 3.6+ are installed

### Debug Commands
- Check EC2 instance status: `aws ec2 describe-instances --instance-ids <ID> --query 'Reservations[0].Instances[0].State.Name'`
- View complete Tomcat logs: SSH to instance and check `/opt/tomcat/logs/`
- Test connectivity: `curl http://<INSTANCE_IP>:8080`
